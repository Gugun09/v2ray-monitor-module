<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V2Ray Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .log-box {
            background: #1e1e1e;
            color: #0f0;
            padding: 1rem;
            height: 200px;
            overflow-y: auto;
            border-radius: 0.375rem;
            font-family: monospace;
            white-space: pre-wrap;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #6b21a8 0%, #2563eb 100%);
        }
        
        .btn-primary {
            background-color: #4f46e5;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background-color: #4338ca;
            transform: translateY(-1px);
        }
        
        .btn-success {
            background-color: #10b981;
            transition: all 0.3s ease;
        }
        
        .btn-success:hover {
            background-color: #059669;
            transform: translateY(-1px);
        }
        
        .btn-danger {
            background-color: #ef4444;
            transition: all 0.3s ease;
        }
        
        .btn-danger:hover {
            background-color: #dc2626;
            transform: translateY(-1px);
        }
        
        .btn-warning {
            background-color: #f59e0b;
            transition: all 0.3s ease;
        }
        
        .btn-warning:hover {
            background-color: #d97706;
            transform: translateY(-1px);
        }
        
        .card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .badge {
            padding: 0.35em 0.65em;
            font-size: 0.75em;
            font-weight: 700;
            letter-spacing: 0.05em;
        }
        
        .toast {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="gradient-bg text-white py-6 shadow-lg">
        <div class="container mx-auto px-4">
            <div class="flex flex-col items-center">
                <div class="flex items-center mb-2">
                    <i class="fas fa-shield-alt text-3xl mr-3"></i>
                    <h1 class="text-3xl font-bold">V2Ray Monitor</h1>
                </div>
                <div class="bg-indigo-700 rounded-full px-4 py-1 flex items-center">
                    <i class="fas fa-microchip mr-2 text-sm"></i>
                    <span id="models" class="text-sm font-medium">Memuat...</span>
                </div>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8 max-w-4xl">
        <!-- Status Card -->
        <div class="card bg-white rounded-xl shadow-md overflow-hidden mb-6">
            <div class="p-6">
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 rounded-full bg-indigo-100 flex items-center justify-center mr-3">
                        <i class="fas fa-power-off text-indigo-600"></i>
                    </div>
                    <h2 class="text-xl font-semibold text-gray-800">Status V2Ray</h2>
                </div>
                
                <div class="flex flex-col items-center mb-4">
                    <span class="text-gray-600 mb-2">Status saat ini:</span>
                    <span id="status" class="badge bg-gray-200 text-gray-800">Memuat...</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <button onclick="control('start')" class="btn-success text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center">
                        <i class="fas fa-play mr-2"></i> Start
                    </button>
                    <button onclick="control('stop')" class="btn-danger text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center">
                        <i class="fas fa-stop mr-2"></i> Stop
                    </button>
                    <button onclick="control('restart')" class="btn-warning text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center">
                        <i class="fas fa-redo mr-2"></i> Restart
                    </button>
                </div>
            </div>
        </div>

        <!-- USB Tethering Card -->
        <div class="card bg-white rounded-xl shadow-md overflow-hidden mb-6">
            <div class="p-6">
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center mr-3">
                        <i class="fas fa-plug text-blue-600"></i>
                    </div>
                    <h2 class="text-xl font-semibold text-gray-800">USB Tethering</h2>
                </div>
                
                <div class="flex flex-col items-center mb-4">
                    <span class="text-gray-600 mb-2">Status saat ini:</span>
                    <span id="usbStatus" class="badge bg-gray-200 text-gray-800">Memuat...</span>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    <button onclick="tetherControl('start')" class="btn-success text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center">
                        <i class="fas fa-plug mr-2"></i> Start USB Tethering
                    </button>
                    <button onclick="tetherControl('stop')" class="btn-danger text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center">
                        <i class="fas fa-unplug mr-2"></i> Stop USB Tethering
                    </button>
                </div>
            </div>
        </div>

        <!-- Cloudflare Tunnel Card -->
        <div class="card bg-white rounded-xl shadow-md overflow-hidden mb-6">
            <div class="p-6">
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 rounded-full bg-purple-100 flex items-center justify-center mr-3">
                        <i class="fas fa-cloud text-purple-600"></i>
                    </div>
                    <h2 class="text-xl font-semibold text-gray-800">Cloudflare Tunnel</h2>
                </div>
                
                <div class="flex flex-col gap-3">
                    <div class="relative mb-2">
                        <input type="text" id="tunnelUrl" class="w-full py-2 px-4 pr-16 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500" value="ðŸ”„ Menunggu URL..." readonly>
                        <button onclick="copyTunnelUrl()" class="absolute right-2 top-1/2 transform -translate-y-1/2 bg-indigo-600 text-white px-3 py-1 rounded-md text-sm hover:bg-indigo-700 transition">
                            <i class="fas fa-copy mr-1"></i> Copy
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <button onclick="tunnelControl('start')" class="btn-success text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center">
                            <i class="fas fa-play mr-2"></i> Start Tunnel
                        </button>
                        <button onclick="tunnelControl('stop')" class="btn-danger text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center">
                            <i class="fas fa-stop mr-2"></i> Stop Tunnel
                        </button>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">Gunakan URL ini untuk mengakses V2Ray melalui Cloudflare Tunnel</p>
                </div>
            </div>
        </div>

        <!-- Log Card -->
        <div class="card bg-white rounded-xl shadow-md overflow-hidden mb-6">
            <div class="p-6">
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center mr-3">
                        <i class="fas fa-terminal text-green-600"></i>
                    </div>
                    <h2 class="text-xl font-semibold text-gray-800">Live Log</h2>
                </div>
                
                <div class="relative">
                    <pre class="log-box" id="log">ðŸ”„ Memuat log...</pre>
                    <button onclick="document.getElementById('log').scrollTop = document.getElementById('log').scrollHeight" class="absolute right-2 bottom-2 bg-gray-800 text-white px-2 py-1 rounded-md text-xs hover:bg-gray-700 transition">
                        <i class="fas fa-arrow-down mr-1"></i> Scroll Down
                    </button>
                </div>
            </div>
        </div>

        <!-- Telegram Config Card -->
        <div class="card bg-white rounded-xl shadow-md overflow-hidden mb-6">
            <div class="p-6">
                <div class="flex items-center mb-4">
                    <div class="w-10 h-10 rounded-full bg-teal-100 flex items-center justify-center mr-3">
                        <i class="fab fa-telegram text-teal-600"></i>
                    </div>
                    <h2 class="text-xl font-semibold text-gray-800">Pengaturan Telegram Bot</h2>
                </div>
                
                <div class="space-y-4">
                    <div>
                        <label for="botToken" class="block text-sm font-medium text-gray-700 mb-1">Bot Token</label>
                        <div class="relative">
                            <input type="text" id="botToken" class="w-full py-2 px-4 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Masukkan token bot Telegram">
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                <i class="fas fa-key text-gray-400"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div>
                        <label for="chatId" class="block text-sm font-medium text-gray-700 mb-1">Chat ID</label>
                        <div class="relative">
                            <input type="text" id="chatId" class="w-full py-2 px-4 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Masukkan ID chat Telegram">
                            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
                                <i class="fas fa-id-card text-gray-400"></i>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <button onclick="updateBotConfig()" class="btn-primary text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center">
                            <i class="fas fa-save mr-2"></i> Simpan Pengaturan
                        </button>
                        <button onclick="sendTestMessage()" class="bg-amber-500 hover:bg-amber-600 text-white font-medium py-2 px-4 rounded-lg flex items-center justify-center">
                            <i class="fas fa-paper-plane mr-2"></i> Kirim Pesan Uji
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-gray-800 text-white py-6 mt-8">
        <div class="container mx-auto px-4">
            <div class="flex flex-col items-center text-center">
                <div class="flex items-center mb-2">
                    <i class="fas fa-code text-indigo-300 mr-2"></i>
                    <p class="text-sm">Dibuat oleh <strong id="devName" class="text-indigo-300">Memuat...</strong></p>
                </div>
                <div class="flex flex-wrap justify-center gap-4 mb-3">
                    <div class="flex items-center">
                        <span class="bg-blue-500 text-white text-xs px-2 py-1 rounded-full mr-2">App</span>
                        <span id="appVersion" class="text-xs">Memuat...</span>
                    </div>
                    <div class="flex items-center">
                        <span class="bg-purple-500 text-white text-xs px-2 py-1 rounded-full mr-2">Code</span>
                        <span id="codeVersion" class="text-xs">Memuat...</span>
                    </div>
                </div>
                <p class="text-xs text-gray-400">&copy; 2025 - Semua Hak Dilindungi | Cloudflare Tunnel & V2Ray Monitor</p>
            </div>
        </div>
    </footer>

    <!-- Toast Container -->
    <div class="fixed top-4 right-4 z-50 space-y-2 w-80" id="toastContainer"></div>

    <script>
        function showToast(message, type = "info") {
            let toastId = `toast-${Date.now()}`;
            let icon = "";
            let bgColor = "";
            
            switch(type) {
                case "success":
                    icon = "fa-check-circle";
                    bgColor = "bg-green-500";
                    break;
                case "danger":
                    icon = "fa-times-circle";
                    bgColor = "bg-red-500";
                    break;
                case "warning":
                    icon = "fa-exclamation-triangle";
                    bgColor = "bg-yellow-500";
                    break;
                default:
                    icon = "fa-info-circle";
                    bgColor = "bg-blue-500";
            }
            
            let toastHtml = `
                <div id="${toastId}" class="toast flex items-center ${bgColor} text-white px-4 py-3 rounded-lg shadow-lg animate-fade-in">
                    <i class="fas ${icon} mr-3 text-xl"></i>
                    <div class="flex-1">${message}</div>
                    <button type="button" class="ml-3 text-white opacity-70 hover:opacity-100" onclick="document.getElementById('${toastId}').remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;

            let toastContainer = document.getElementById("toastContainer");
            let toastElement = document.createElement("div");
            toastElement.innerHTML = toastHtml;
            toastContainer.appendChild(toastElement);

            setTimeout(() => {
                toastElement.remove();
            }, 5000);
        }

        function getEl(id) {
            return document.getElementById(id);
        }

        function fetchWithToast(url, options = {}, successType = "success", errorType = "danger", onSuccess, onError) {
            fetch(url, options)
                .then(response => response.text())
                .then(result => {
                    showToast(result, successType);
                    if (onSuccess) onSuccess(result);
                })
                .catch(error => {
                    showToast("âŒ Error: " + error, errorType);
                    if (onError) onError(error);
                });
        }

        function control(action) {
            fetchWithToast(`/cgi-bin/${action}.sh`, {}, "success", "danger", () => checkStatus());
        }

        function tetherControl(action) {
            fetchWithToast(`/cgi-bin/usb_tether.sh?action=${action}`, {}, "success", "danger", () => checkUsbStatus());
        }

        function tunnelControl(action) {
            fetchWithToast(`/cgi-bin/tunnel.sh?${action}`, {}, "success", "danger");
        }

        function checkUsbStatus() {
            fetch(`/cgi-bin/status_usb.sh`)
                .then(response => response.text())
                .then(status => {
                    let statusElement = getEl("usbStatus");
                    statusElement.innerText = status.includes("enabled") ? "Aktif" : "Nonaktif";
                    statusElement.className = status.includes("enabled") ? "badge bg-green-100 text-green-800" : "badge bg-red-100 text-red-800";
                })
                .catch(error => {
                    getEl("usbStatus").innerText = "Gagal";
                    getEl("usbStatus").className = "badge bg-yellow-100 text-yellow-800";
                });
        }

        function checkStatus() {
            fetch(`/cgi-bin/status.sh`).then(response => response.text()).then(status => {
                getEl("status").innerText = status;
                getEl("status").className = status.includes("Running") ? "badge bg-green-100 text-green-800" : "badge bg-red-100 text-red-800";
            }).catch(error => {
                getEl("status").innerText = "Gagal";
                getEl("status").className = "badge bg-yellow-100 text-yellow-800";
            });
        }

        function updateLog() {
            fetch(`/cgi-bin/log.sh`).then(response => response.text()).then(logs => {
                let logElement = getEl("log");
                logElement.innerText = logs;
                logElement.scrollTop = logElement.scrollHeight;
            }).catch(error => {
                getEl("log").innerText = "ðŸš« Gagal memuat log";
            });
        }

        function updateBotConfig() {
            const botToken = getEl("botToken").value;
            const chatId = getEl("chatId").value;
            fetchWithToast('/cgi-bin/update_env.sh', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ botToken, chatId })
            });
        }

        function sendTestMessage() {
            fetch('/cgi-bin/send_telegram_message.sh').then(response => response.json()).then(result => {
                showToast(result.ok ? "âœ… Pesan terkirim!" : "âŒ Gagal mengirim pesan", result.ok ? "success" : "danger");
            }).catch(error => showToast("ðŸš« Error: " + error, "danger"));
        }

        function loadBotConfig() {
            fetch('/cgi-bin/get_bot_config.sh')
                .then(response => response.json())
                .then(data => {
                    getEl("botToken").value = data.botToken;
                    getEl("chatId").value = data.chatId;
                    getEl("models").innerText = data.hostname;

                    let tunnelElement = getEl("tunnelUrl");
                    if (tunnelElement.tagName === "INPUT") {
                        tunnelElement.value = data.tunnelUrl;
                    } else {
                        tunnelElement.innerText = data.tunnelUrl;
                    }
                })
                .catch(error => showToast("âŒ Gagal memuat pengaturan", "danger"));
        }

        function loadVersionInfo() {
            fetch('/cgi-bin/get_version.sh')
                .then(response => response.json())
                .then(data => {
                    getEl("devName").innerText = data.devName;
                    getEl("appVersion").innerText = data.appVersion;
                    getEl("codeVersion").innerText = data.codeVersion;
                })
                .catch(error => showToast("âŒ Gagal memuat versi", "danger"));
        }

        function copyTunnelUrl() {
            let tunnelInput = getEl("tunnelUrl");
            tunnelInput.select();
            tunnelInput.setSelectionRange(0, 99999);

            navigator.clipboard.writeText(tunnelInput.value).then(() => {
                showToast("ðŸ“‹ URL berhasil disalin!", "success");
            }).catch(err => {
                showToast("âŒ Gagal menyalin URL", "danger");
            });
        }

        function checkForUpdate() {
            fetch('/cgi-bin/check_update.sh')
                .then(response => response.json())
                .then(data => {
                    const localVersion = getEl("appVersion").innerText;
                    if (data.version && data.version !== localVersion) {
                        showToast(`Update tersedia: v${data.version} <button onclick=\"doUpdate('${data.url}')\" class=\"underline\">Update</button>`, "warning");
                    }
                });
        }

        function doUpdate(url) {
            fetch('/cgi-bin/do_update.sh?url=' + encodeURIComponent(url))
                .then(response => response.text())
                .then(result => showToast(result, "success"))
                .catch(error => showToast("Gagal update: " + error, "danger"));
        }

        setInterval(checkStatus, 5000);
        setInterval(checkUsbStatus, 5000);
        setInterval(updateLog, 3000);
        window.onload = () => {
            checkStatus();
            updateLog();
            loadBotConfig();
            loadVersionInfo();
            checkUsbStatus();
            checkForUpdate();
        };
    </script>
</body>
</html>