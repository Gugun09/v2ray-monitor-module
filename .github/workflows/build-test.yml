name: ğŸ§ª Build and Test Module

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  MODULE_NAME: v2ray_monitor

jobs:
  validate:
    name: ğŸ” Validate Module Structure
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v5

      - name: ğŸ” Check Required Files
        run: |
          echo "ğŸ” Checking required module files..."
          
          REQUIRED_FILES=(
            "module.prop"
            "service.sh"
            "customize.sh"
            "uninstall.sh"
            "system/xbin/v2ray_monitor.sh"
            "system/xbin/v2ray_monitor_service"
            "ui/www/index.html"
            "ui/www/js/app.js"
            "ui/start_server.sh"
            "ui/stop_server.sh"
            ".env-example"
            "README.md"
            "CHANGELOG.md"
          )
          
          MISSING_FILES=()
          for file in "${REQUIRED_FILES[@]}"; do
            if [[ ! -f "$file" ]]; then
              MISSING_FILES+=("$file")
            fi
          done
          
          if [[ ${#MISSING_FILES[@]} -gt 0 ]]; then
            echo "âŒ Missing required files:"
            printf '%s\n' "${MISSING_FILES[@]}"
            exit 1
          fi
          
          echo "âœ… All required files present"

      - name: ğŸ”§ Validate Module Properties
        run: |
          echo "ğŸ”§ Validating module.prop..."
          
          # Check required properties
          REQUIRED_PROPS=("id" "name" "version" "versionCode" "author" "description")
          
          for prop in "${REQUIRED_PROPS[@]}"; do
            if ! grep -q "^${prop}=" module.prop; then
              echo "âŒ Missing property: $prop"
              exit 1
            fi
          done
          
          # Validate version format
          VERSION=$(grep "^version=" module.prop | cut -d'=' -f2)
          if [[ ! $VERSION =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Invalid version format: $VERSION"
            exit 1
          fi
          
          # Validate version code
          VERSION_CODE=$(grep "^versionCode=" module.prop | cut -d'=' -f2)
          if [[ ! $VERSION_CODE =~ ^[0-9]+$ ]]; then
            echo "âŒ Invalid version code: $VERSION_CODE"
            exit 1
          fi
          
          echo "âœ… Module properties valid"
          echo "ğŸ“‹ Module ID: $(grep "^id=" module.prop | cut -d'=' -f2)"
          echo "ğŸ“‹ Version: $VERSION"
          echo "ğŸ“‹ Version Code: $VERSION_CODE"

      - name: ğŸ” Validate Shell Scripts
        run: |
          echo "ğŸ” Validating shell scripts..."
          
          SHELL_SCRIPTS=(
            "service.sh"
            "customize.sh"
            "uninstall.sh"
            "system/xbin/v2ray_monitor.sh"
            "system/xbin/v2ray_monitor_service"
            "ui/start_server.sh"
            "ui/stop_server.sh"
          )
          
          for script in "${SHELL_SCRIPTS[@]}"; do
            if [[ -f "$script" ]]; then
              echo "Checking $script..."
              
              # Check shebang
              if ! head -n1 "$script" | grep -q "^#!/"; then
                echo "âš ï¸  Missing shebang in $script"
              fi
              
              # Basic syntax check (if shellcheck is available)
              if command -v shellcheck >/dev/null 2>&1; then
                if ! shellcheck -e SC1091 -e SC2034 -e SC2086 "$script"; then
                  echo "âš ï¸  Shellcheck warnings in $script"
                fi
              fi
              
              echo "âœ… $script validated"
            fi
          done

      - name: ğŸŒ Validate Web UI
        run: |
          echo "ğŸŒ Validating web UI files..."
          
          # Check HTML structure
          if [[ -f "ui/www/index.html" ]]; then
            if ! grep -q "<html" ui/www/index.html; then
              echo "âŒ Invalid HTML structure"
              exit 1
            fi
            echo "âœ… HTML structure valid"
          fi
          
          # Check JavaScript
          if [[ -f "ui/www/js/app.js" ]]; then
            # Basic JS validation
            if ! node -c ui/www/js/app.js 2>/dev/null; then
              echo "âš ï¸  JavaScript syntax warnings"
            else
              echo "âœ… JavaScript syntax valid"
            fi
          fi
          
          # Check CGI scripts
          CGI_SCRIPTS=(ui/www/cgi-bin/*.sh)
          for script in "${CGI_SCRIPTS[@]}"; do
            if [[ -f "$script" ]]; then
              if ! head -n1 "$script" | grep -q "^#!/"; then
                echo "âš ï¸  Missing shebang in $script"
              fi
            fi
          done
          
          echo "âœ… Web UI validation completed"

  build-test:
    name: ğŸ”¨ Build Test Package
    needs: validate
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v5

      - name: ğŸ”¨ Create Test Package
        run: |
          echo "ğŸ”¨ Creating test package..."
          
          # Create build directory
          mkdir -p build
          
          # Copy all files
          cp -r \
            module.prop \
            service.sh \
            customize.sh \
            uninstall.sh \
            system/ \
            ui/ \
            .env-example \
            README.md \
            CHANGELOG.md \
            update.json \
            build/
          
          # Create ZIP
          cd build
          zip -r "../v2ray-monitor-module-test.zip" . -x "*.git*" "*.github*"
          cd ..
          
          echo "âœ… Test package created"
          echo "ğŸ“¦ Package size: $(du -h v2ray-monitor-module-test.zip | cut -f1)"

      - name: ğŸ§ª Test Package Contents
        run: |
          echo "ğŸ§ª Testing package contents..."
          
          # Extract and verify
          mkdir -p test-extract
          unzip -q v2ray-monitor-module-test.zip -d test-extract/
          
          # Check structure
          if [[ ! -f "test-extract/module.prop" ]]; then
            echo "âŒ module.prop missing from package"
            exit 1
          fi
          
          if [[ ! -d "test-extract/system" ]]; then
            echo "âŒ system directory missing from package"
            exit 1
          fi
          
          if [[ ! -d "test-extract/ui" ]]; then
            echo "âŒ ui directory missing from package"
            exit 1
          fi
          
          echo "âœ… Package structure valid"
          
          # List contents
          echo "ğŸ“‹ Package contents:"
          unzip -l v2ray-monitor-module-test.zip

      - name: ğŸ“¤ Upload Test Package
        uses: actions/upload-artifact@v4
        with:
          name: v2ray-monitor-module-test
          path: v2ray-monitor-module-test.zip
          retention-days: 7

  security-scan:
    name: ğŸ”’ Security Scan
    needs: validate
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v5

      - name: ğŸ”’ Scan for Secrets
        run: |
          echo "ğŸ”’ Scanning for potential secrets..."
          
          # Check for common secret patterns
          SECRET_PATTERNS=(
            "password\s*=\s*['\"][^'\"]+['\"]"
            "token\s*=\s*['\"][^'\"]+['\"]"
            "key\s*=\s*['\"][^'\"]+['\"]"
            "secret\s*=\s*['\"][^'\"]+['\"]"
          )
          
          FOUND_SECRETS=false
          for pattern in "${SECRET_PATTERNS[@]}"; do
            if grep -r -i -E "$pattern" . --exclude-dir=.git --exclude-dir=.github; then
              echo "âš ï¸  Potential secret found: $pattern"
              FOUND_SECRETS=true
            fi
          done
          
          if $FOUND_SECRETS; then
            echo "âš ï¸  Please review potential secrets above"
          else
            echo "âœ… No obvious secrets found"
          fi

      - name: ğŸ” Check File Permissions
        run: |
          echo "ğŸ” Checking file permissions..."
          
          # Check for executable files
          find . -type f -executable -not -path "./.git/*" -not -path "./.github/*" | while read -r file; do
            echo "ğŸ“‹ Executable: $file"
          done
          
          # Check shell scripts have proper permissions
          find . -name "*.sh" -not -path "./.git/*" -not -path "./.github/*" | while read -r script; do
            if [[ ! -x "$script" ]]; then
              echo "âš ï¸  Script not executable: $script"
            fi
          done
          
          echo "âœ… Permission check completed"

  documentation:
    name: ğŸ“š Documentation Check
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v5

      - name: ğŸ“š Check Documentation
        run: |
          echo "ğŸ“š Checking documentation..."
          
          # Check README
          if [[ ! -f "README.md" ]]; then
            echo "âŒ README.md missing"
            exit 1
          fi
          
          # Check CHANGELOG
          if [[ ! -f "CHANGELOG.md" ]]; then
            echo "âŒ CHANGELOG.md missing"
            exit 1
          fi
          
          # Check README content
          README_SECTIONS=("Overview" "Installation" "Features")
          for section in "${README_SECTIONS[@]}"; do
            if ! grep -q "$section" README.md; then
              echo "âš ï¸  README missing section: $section"
            fi
          done
          
          echo "âœ… Documentation check completed"

      - name: ğŸ“Š Generate Report
        run: |
          echo "## ğŸ“Š Build Test Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ” File Structure | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”§ Module Properties | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸŒ Web UI | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”¨ Build Test | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ”’ Security Scan | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "| ğŸ“š Documentation | âœ… Passed |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ¯ Summary" >> $GITHUB_STEP_SUMMARY
          echo "All validation checks passed successfully! ğŸ‰" >> $GITHUB_STEP_SUMMARY