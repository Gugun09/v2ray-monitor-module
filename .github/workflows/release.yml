---
name: 🚀 Release V2Ray Monitor Module

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g., v1.0.4)'
        required: true
        default: 'v1.0.4'

jobs:
  release:
    name: Build and Release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get Version
        id: version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/}"
          fi
          echo "version=${VERSION#v}" >> $GITHUB_OUTPUT
          echo "tag=$VERSION" >> $GITHUB_OUTPUT

      - name: Update Files
        run: |
          # Update module.prop
          sed -i "s/^version=.*/version=${{ steps.version.outputs.version }}/" module.prop
          
          # Update version in scripts
          sed -i "s/v[0-9]\+\.[0-9]\+\.[0-9]\+/v${{ steps.version.outputs.version }}/g" customize.sh
          
          # Update get_version.sh
          sed -i "s/\"appVersion\": \"[^\"]*\"/\"appVersion\": \"${{ steps.version.outputs.version }}\"/g" ui/www/cgi-bin/get_version.sh
          
          # Update update.json
          cat > update.json << EOF
          {
            "version": "${{ steps.version.outputs.version }}",
            "versionCode": $(echo "${{ steps.version.outputs.version }}" | tr -d '.'),
            "zipUrl": "https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/v2ray-monitor-module.zip",
            "changelog": "https://github.com/${{ github.repository }}/raw/main/CHANGELOG.md"
          }
          EOF

      - name: Create Package
        run: |
          mkdir package
          cp -r \
            module.prop \
            service.sh \
            customize.sh \
            uninstall.sh \
            system/ \
            ui/ \
            .env-example \
            README.md \
            CHANGELOG.md \
            update.json \
            package/
          
          cd package
          zip -r ../v2ray-monitor-module.zip .
          cd ..

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: V2Ray Monitor v${{ steps.version.outputs.version }}
          body: |
            ## V2Ray Monitor Module v${{ steps.version.outputs.version }}
            
            ### 📥 Installation
            1. Download `v2ray-monitor-module.zip`
            2. Install via Magisk Manager
            3. Reboot device
            
            ### ✨ Features
            - 🔄 Auto V2Ray monitoring and restart
            - 🌐 Web dashboard at http://localhost:9091
            - 📱 Telegram notifications
            - ☁️ Cloudflare Tunnel support
            - 🔌 USB Tethering control
            
            ### 📋 Requirements
            - Android device with root access
            - Magisk installed
            - V2rayNG app
            
            ---
            
            **Download**: [v2ray-monitor-module.zip](https://github.com/${{ github.repository }}/releases/download/${{ steps.version.outputs.tag }}/v2ray-monitor-module.zip)
          files: v2ray-monitor-module.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update Repository
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add module.prop update.json ui/www/cgi-bin/get_version.sh customize.sh
          git commit -m "🔄 Update version to ${{ steps.version.outputs.version }}" || true
          git push || true
